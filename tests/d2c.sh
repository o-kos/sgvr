#!/bin/bash

# dat2csv.sh - Скрипт для конвертации .dat файлов от SoX в .csv формат
# Автоматически определяет моно или стерео сигнал и генерирует
# CSV с колонками: время, номер фрейма, канал 1, [канал 2]

# Прекращаем выполнение скрипта, если любая команда завершится с ошибкой
set -e
# Прекращаем выполнение, если команда в конвейере (pipe) завершится с ошибкой
set -o pipefail

# --- 1. Проверка входных аргументов ---
if [ "$#" -ne 1 ]; then
    echo "Ошибка: Не указан входной файл."
    echo "Использование: $0 <имя_файла.dat>"
    exit 1
fi

DAT_FILE="$1"

if [ ! -f "$DAT_FILE" ]; then
    echo "Ошибка: Файл '$DAT_FILE' не найден."
    exit 1
fi

# --- 2. Определение количества каналов ---
echo "Анализ файла: $DAT_FILE"
# Ищем строку "; Channels" и берем последнее слово в этой строке (число каналов)
# Также удаляем символы \r и пробелы
CHANNELS=$(grep '; Channels' "$DAT_FILE" | awk '{print $NF}' | tr -d '\r' | tr -d ' ')

if [ -z "$CHANNELS" ]; then
    echo "Ошибка: Не удалось определить количество каналов в файле '$DAT_FILE'."
    echo "Убедитесь, что файл был сгенерирован SoX и содержит строку '; Channels'."
    exit 1
fi

# --- 3. Выбор и запуск нужной команды awk ---
CSV_FILE="${DAT_FILE%.dat}.csv" # Заменяем расширение .dat на .csv
echo "Обнаружено каналов: $CHANNELS"
echo "Выходной файл: $CSV_FILE"
echo "Запуск конвертации..."

if [ "$CHANNELS" -eq 2 ]; then
    # --- Стерео ---
    echo "Выбран режим для стерео файла."
    awk '
    BEGIN {
        print "время,номер фрейма,канал 1,канал 2";
        frame_num = 0;
    }
    !/^;/ {
        printf "%.8f,%d,%.8f,%.8f\n", $1, frame_num, $2, $3;
        frame_num++;
    }
    ' "$DAT_FILE" > "$CSV_FILE"

elif [ "$CHANNELS" -eq 1 ]; then
    # --- Моно ---
    echo "Выбран режим для моно файла."
    awk '
    BEGIN {
        print "время,номер фрейма,канал 1";
        frame_num = 0;
    }
    !/^;/ {
        printf "%.8f,%d,%.8f\n", $1, frame_num, $2;
        frame_num++;
    }
    ' "$DAT_FILE" > "$CSV_FILE"
else
    # --- Неподдерживаемое количество каналов ---
    echo "Ошибка: Скрипт поддерживает только 1 или 2 канала, а обнаружено $CHANNELS."
    exit 1
fi

echo "Готово! Файл '$CSV_FILE' успешно создан."